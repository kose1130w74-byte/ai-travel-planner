<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI旅行プランナー（大学生向け）</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", sans-serif; margin: 20px; max-width: 900px; }
    h1 { margin-bottom: 0; }
    small { color: #666; }
    label { font-weight: bold; display: block; margin-top: 15px; }
    input, textarea {
      width: 100%; padding: 8px; margin-top: 5px; border-radius: 6px;
      border: 1px solid #ccc; box-sizing: border-box; font-size: 14px;
    }
    button {
      margin-top: 20px; padding: 10px 20px; border: none; border-radius: 6px;
      font-size: 15px; cursor: pointer; background: #2563eb; color: #fff;
    }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    #user-only-output, #plan-output {
      white-space: pre-wrap; background: #f7f7f7; padding: 15px; border-radius: 8px;
      margin-top: 10px; font-size: 13px;
    }
    #plan-output { background: #eef7ff; }
    .hint { font-size: 12px; color: #666; margin-top: 6px; }
  </style>
</head>
<body>

<h1>AI旅行プランナー</h1>
<small>大学生向けの国内旅行プランをAIが自動生成します</small>

<form id="travel-form">
  <label>出発地</label>
  <input type="text" id="start" placeholder="例：大阪" required>

  <label>行きたいエリア（ざっくりでもOK）</label>
  <input type="text" id="area" placeholder="例：京都・奈良">

  <label>総予算（一人あたり・円）</label>
  <input type="number" id="budget" placeholder="例：20000" required>

  <label>日数</label>
  <input type="number" id="days" placeholder="例：2" required>

  <label>人数</label>
  <input type="number" id="people" placeholder="例：1" required>

  <label>旅行の目的</label>
  <input type="text" id="purpose" placeholder="例：食べ歩き中心。寺社も少し。写真映えも。">

  <label>好み・条件（あれば）</label>
  <textarea id="preference" rows="2" placeholder="例：宿泊費は節約、歩くのはOK。夜はゆっくりしたい。"></textarea>

  <label>行きたくない場所・避けたいこと（あれば）</label>
  <textarea id="avoid" rows="2" placeholder="例：人混みが苦手。移動が長すぎるのは避けたい。"></textarea>

  <label>行く時期（ざっくりでOK）</label>
  <input type="text" id="season" placeholder="例：3月（春休み）">

  <button id="submit-btn" type="submit">AIで旅行プランを作る</button>
  <div class="hint">※ 例文は“入力欄の薄い文字（placeholder）”です。送信しない限り画面に残りません。</div>
</form>

<h2>① ユーザー条件（AIに渡した内容）</h2>
<div id="user-only-output">未送信</div>

<h2>② 生成された旅行プラン</h2>
<div id="plan-output">ここにAIからのプランが表示されます</div>

<script>
  const form = document.getElementById("travel-form");
  const userOut = document.getElementById("user-only-output");
  const planOut = document.getElementById("plan-output");
  const submitBtn = document.getElementById("submit-btn");

  function val(id) {
    return document.getElementById(id).value.trim();
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const start = val("start");
    const area = val("area") || "未指定";
    const budget = val("budget");
    const days = val("days");
    const people = val("people");
    const purpose = val("purpose") || "特になし";
    const preference = val("preference") || "特になし";
    const avoid = val("avoid") || "特になし";
    const season = val("season") || "未指定";

    const userPart =
`- 出発地：${start}
- 行きたいエリア（ざっくりでも可）：${area}
- 総予算（一人あたり、現地で使うお金＋交通費＋宿泊費すべて）：${budget}円
- 日数：${days}日
- 人数：${people}人
- 旅行の目的：${purpose}
- 好み：${preference}
- 行きたくない場所・避けたいこと：${avoid}
- 行く時期：${season}`;

    userOut.textContent = userPart;
    planOut.textContent = "AIが旅行プランを考えています…";
    submitBtn.disabled = true;

    try {
      const res = await fetch("/api/plan", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userInput: userPart }),
      });

      // まず本文をテキストで受け取って、JSONならJSONにする（エラー時も内容が見える）
      const raw = await res.text();
      let data = null;
      try { data = raw ? JSON.parse(raw) : null; } catch (_) {}

      if (!res.ok) {
        const msg =
          (data && (data.error || data.message)) ||
          raw ||
          "不明なエラー";
        planOut.textContent =
          `エラー（HTTP ${res.status}）: ${msg}\n\n` +
          `対処ヒント：RenderのLogsで直前のエラー行を確認してね。`;
        return;
      }

      planOut.textContent = (data && data.plan) ? data.plan : "プランを取得できませんでした。";
    } catch (err) {
      console.error(err);
      planOut.textContent = "通信エラー：ネットワークかサーバー側で落ちている可能性があります。";
    } finally {
      submitBtn.disabled = false;
    }
  });
</script>

</body>
</html>
